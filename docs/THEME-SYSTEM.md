# Theme System Documentation

## Overview

MaxType features a sophisticated theme system with **warm creamy light** and **elegant dark** themes, plus system preference detection. The design philosophy emphasizes **refined aesthetics** with OKLCH-based color science, smooth transitions, persistent user preferences, and flicker-free SSR support.

## Design Philosophy

### Visual Identity

- **Light Theme**: Warm creamy neutral base with elegant slate accents
- **Dark Theme**: Balanced dark backgrounds with refined contrast
- **Accent Colors**: Sophisticated palette using OKLCH color space for perceptual uniformity
- **Typography**: System fonts with Roboto Mono for code/branding elements

### User Experience Principles

- **Instant Response**: Immediate theme application with smooth transitions
- **System Integration**: Respects OS theme preferences by default
- **Accessibility**: High contrast ratios and proper color combinations
- **Consistency**: Unified design language across all components

## Interactive Theme Showcase

Visit **`/theme-test`** to explore the complete design system with:

- Live color palette demonstration
- Component variants in both themes
- Interactive form elements
- Message alert variations
- Typography and spacing examples

## Core Components

### Theme Hook (`src/lib/theme.ts`)

- **`useTheme()`** - Main hook for theme management
  - Integrates with user preferences system
  - Handles system theme detection via `matchMedia`
  - Provides smooth transitions for user-initiated changes
  - Manages theme persistence (localStorage for guests, database for authenticated users)

### Theme Selector (`src/components/ui/ThemeSelect.tsx`)

- Icon-only dropdown in header (Sun ‚òÄÔ∏è, Moon üåô, Monitor üíª)
- Integrates with Radix UI Select component
- Available to both authenticated and guest users
- Proper accessibility with ARIA labels

### Theme Integration

- **User Preferences**: Theme field added to `PreferenceSchema` in validation.ts
- **PayloadCMS**: Theme field added to Users collection preferences group
- **Default**: System preference (`theme: 'system'`)

## Technical Implementation

### Theme Values

```typescript
type Theme = 'light' | 'dark' | 'system'
type ResolvedTheme = 'light' | 'dark' // system resolved to actual theme
```

### CSS Architecture

- **TailwindCSS 4.0** with built-in dark mode support
- **OKLCH Color Space**: Perceptually uniform colors for consistent visual experience
- **CSS Custom Properties** for comprehensive theme variables in `styles.css`
- **Scoped Transitions**: `.theme-transitioning` class applied temporarily (0.15s duration)
- **Inline Style Fallback**: Prevents flicker during initial load

## Color Palette & Design System

### OKLCH-Based Color Science

MaxType uses the OKLCH color space for perceptually uniform colors that maintain consistent lightness and saturation across themes:

#### Light Theme Colors

```css
/* Warm creamy neutral base */
--background: oklch(0.97 0.006 55); /* Soft cream background */
--foreground: oklch(0.23 0.008 30); /* Deep neutral text */
--card: oklch(0.99 0.003 50); /* Clean card background */

/* Elegant refined slate accent */
--primary: oklch(0.52 0.03 250); /* Sophisticated slate blue */
--primary-foreground: oklch(0.99 0.003 50);

/* Warm secondary tones */
--secondary: oklch(0.96 0.005 55); /* Subtle warm secondary */
--muted: oklch(0.96 0.005 55); /* Muted warm elements */
--muted-foreground: oklch(0.48 0.02 40);

/* Sophisticated message colors */
--success: oklch(0.55 0.08 160); /* Elegant green */
--warning: oklch(0.6 0.1 85); /* Refined gold */
--info: oklch(0.52 0.03 250); /* Refined slate */
--error: oklch(0.58 0.1 25); /* Elegant coral */
--destructive: oklch(0.65 0.15 15); /* Warm coral for destructive actions */

/* Warm borders and inputs */
--border: oklch(0.88 0.008 60); /* Soft warm borders */
--input: oklch(0.98 0.004 55); /* Clean input backgrounds */
--ring: oklch(0.52 0.03 250); /* Focus ring accent */

/* Elegant chart colors */
--chart-1: oklch(0.52 0.03 250); /* Primary slate */
--chart-2: oklch(0.55 0.08 160); /* Success green */
--chart-3: oklch(0.55 0.05 200); /* Info blue */
--chart-4: oklch(0.6 0.1 85); /* Warning gold */
--chart-5: oklch(0.58 0.1 25); /* Error coral */
```

#### Dark Theme Colors

```css
/* Balanced dark backgrounds (auto-generated by TailwindCSS 4.0) */
/* Maintains perceptual consistency with light theme */
/* Proper contrast ratios for accessibility */
/* Elegant dark variations of all light theme colors */
```

### Typography System

#### Font Stack

```css
/* Primary font family */
body {
  font-family:
    system-ui,
    -apple-system,
    sans-serif;
}

/* Monospace for code and branding */
--font-mono: 'Roboto Mono', monospace;

/* Logo and code elements */
.logo,
code,
pre {
  font-family: var(--font-mono);
}
```

#### Font Smoothing

```css
html {
  -webkit-font-smoothing: antialiased;
}
```

### Component Color Usage

#### Message Alerts

- **Success**: `oklch(0.55 0.08 160)` - Elegant green for positive feedback
- **Warning**: `oklch(0.6 0.1 85)` - Refined gold for caution messages
- **Info**: `oklch(0.52 0.03 250)` - Sophisticated slate for information
- **Error**: `oklch(0.58 0.1 25)` - Elegant coral for error states

#### Interactive Elements

- **Primary Button**: Sophisticated slate with high contrast text
- **Secondary Button**: Warm secondary background with primary text
- **Destructive Button**: Elegant coral for delete/destructive actions
- **Focus Rings**: Consistent slate accent for keyboard navigation

#### Layout Elements

- **Cards**: Clean backgrounds with subtle warm borders
- **Inputs**: Clean backgrounds with warm focus states
- **Borders**: Soft warm borders that don't compete with content
- **Shadows**: Subtle shadows that maintain the warm aesthetic

### SSR & Hydration

- **Initial Script**: `THEME_SCRIPT` in `<head>` applies theme before React hydrates
- **suppressHydrationWarning**: Used on `<html>` element (React-recommended approach)
- **Theme Detection**: Script reads localStorage and system preferences
- **Fallback Styling**: Temporary inline styles until CSS loads

### State Management

- **Guest Users**: localStorage with `maxtype-preferences` key
- **Authenticated Users**: Database storage via PayloadCMS User preferences
- **Migration**: Automatic guest-to-user preference migration on login
- **System Changes**: Real-time listening for system theme changes

## Key Features

### ‚úÖ Implemented Features

- **Three Theme Options**: Light, Dark, System (respects OS preference)
- **Persistent Preferences**: Survives page reloads and browser sessions
- **Smooth Transitions**: 0.15s ease-in-out transitions on theme changes
- **System Theme Monitoring**: Automatically updates when OS theme changes
- **No Hydration Issues**: Proper SSR support with suppressHydrationWarning
- **Guest Support**: Full functionality for non-authenticated users
- **Accessibility**: Proper ARIA labels and keyboard navigation

### User Experience

- **Icon-Only Header**: Compact theme selector in navigation
- **Immediate Feedback**: Instant theme application on selection
- **Cross-Session Persistence**: Preferences maintained across visits
- **Error Handling**: Graceful fallbacks if theme system fails

### Developer Experience

- **Type Safety**: Full TypeScript support with generated PayloadCMS types
- **Test Coverage**: Comprehensive validation tests for theme integration
- **Clean Architecture**: Functional approach with clear separation of concerns
- **Standard Patterns**: Follows React and Next.js best practices

## File Locations

### Core Implementation

- `src/lib/theme.ts` - Theme hook and utility functions
- `src/lib/validation.ts` - Theme field in PreferenceSchema
- `src/lib/preferences.ts` - Theme integration with user preferences
- `src/components/ui/ThemeSelect.tsx` - Theme selector component
- `src/components/ui/ThemeProvider.tsx` - Theme initialization script

### Integration Points

- `src/app/(frontend)/layout.tsx` - Theme script injection and suppressHydrationWarning
- `src/app/(frontend)/styles.css` - Theme CSS variables and transitions
- `src/components/ui/Header.tsx` - Theme selector placement
- `src/collections/Users.ts` - Theme field in PayloadCMS User collection

### Testing

- `src/lib/__tests__/theme.test.ts` - Theme validation and integration tests

## Usage Patterns

### Basic Theme Usage

```typescript
const { theme, resolvedTheme, setTheme, loading } = useTheme()

// Current user preference ('light' | 'dark' | 'system')
console.log(theme)

// Actually applied theme ('light' | 'dark')
console.log(resolvedTheme)

// Change theme with smooth transition
await setTheme('dark')
```

### Error Handling

- All theme operations include proper error handling
- Graceful fallbacks to system/dark theme if issues occur
- User-friendly error logging without exposing internal details

## Common Patterns

- **Theme Detection**: Use `resolvedTheme` for actual applied theme
- **Theme Changes**: Always use `setTheme()` for user-initiated changes
- **System Integration**: Theme automatically syncs with OS preference changes
- **Validation**: All theme values validated through Zod schemas

## Advanced Features

### Smooth Theme Transitions

```css
/* Scoped transition control */
body.theme-transitioning * {
  transition:
    background-color 0.15s ease-in-out,
    border-color 0.15s ease-in-out,
    color 0.15s ease-in-out;
}

/* Applied temporarily during theme changes */
.theme-transitioning {
  /* Transitions active for 150ms + 50ms buffer */
}
```

### Theme Detection & Synchronization

#### System Theme Monitoring

```typescript
// Real-time system theme change detection
const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)')

mediaQuery.addEventListener('change', e => {
  const newSystemTheme = e.matches ? 'dark' : 'light'
  if (userPreference === 'system') {
    applyTheme(newSystemTheme)
  }
})
```

#### Hydration-Safe Theme Application

```typescript
// SSR-safe theme initialization
function getCurrentAppliedTheme(): ResolvedTheme {
  if (typeof window === 'undefined') return 'dark'

  const root = window.document.documentElement
  if (root.classList.contains('light')) return 'light'
  if (root.classList.contains('dark')) return 'dark'

  return getSystemTheme()
}
```

### Theme Persistence Integration

#### Guest User Storage

- **localStorage**: `maxtype-preferences` key with validation
- **Migration Ready**: Automatic transfer when user authenticates
- **Fallback Handling**: Graceful degradation if localStorage unavailable

#### Authenticated User Storage

- **Database Sync**: PayloadCMS User preferences field
- **Real-time Updates**: Immediate theme application + async database save
- **Conflict Resolution**: Database values override localStorage on login

## Performance Considerations

### Optimization Strategies

- **Minimal Bundle Impact**: Functional approach with tree-shaking support
- **Efficient DOM Updates**: Only updates theme classes when actually changing
- **System Monitoring**: Uses native `matchMedia` for optimal performance
- **Transition Control**: Scoped CSS transitions prevent performance issues
- **Hydration Safety**: No flash of wrong theme on initial load

### Memory & CPU Efficiency

- **Event Cleanup**: Proper `removeEventListener` in useEffect cleanup
- **Debounced Updates**: Prevents excessive theme switching
- **Minimal Re-renders**: Optimized state management with useCallback
- **CSS-in-CSS**: Theme variables handled by CSS, not JavaScript

## Accessibility & Standards

### Color Contrast Compliance

- **WCAG AA**: All color combinations meet minimum contrast ratios
- **WCAG AAA**: High-contrast mode available via system preferences
- **Color Blindness**: OKLCH color space provides better accessibility
- **Focus Indicators**: High-contrast focus rings on all interactive elements

### Accessibility Features

```css
/* High contrast mode support */
@media (prefers-contrast: high) {
  :root {
    --border: oklch(0.3 0.02 250);
    --ring: oklch(0.4 0.05 250);
  }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
  body.theme-transitioning * {
    transition: none;
  }
}
```

### Keyboard Navigation

- **Focus Management**: Visible focus indicators in both themes
- **Keyboard Shortcuts**: No theme-specific keyboard shortcuts (follows system)
- **Screen Reader Support**: ARIA labels on theme selector component
